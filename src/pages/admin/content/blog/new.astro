---
import { supabase } from '../../../../lib/supabase/client';
import ContentLayout from '../../../../layouts/ContentLayout.astro';
import { Card, CardContent, CardHeader, CardTitle } from '../../../../components/components/ui/card';
import BlogEditor from '../../../../components/admin/BlogEditor';
import { BlogService } from '../../../../lib/services/blog-service';
import type { BlogPost } from '../../../../types/blog';

// Check authentication
const { data: sessionData } = await supabase.auth.getSession();
const session = sessionData?.session;
const isAuthenticated = !!session?.user;

// Redirect if not authenticated
if (!isAuthenticated) {
  return Astro.redirect('/admin');
}

// Fetch categories
let categories: string[] = [];
try {
  categories = await BlogService.getCategories();
} catch (error) {
  console.error('Error fetching categories:', error);
}
---

<ContentLayout 
  title="Create New Blog Post" 
  description="Create a new blog post for your website"
  createLink="/admin/content/blog"
  createButtonText="Back to Posts"
>
  <Card>
    <CardHeader>
      <CardTitle>Blog Post Editor</CardTitle>
    </CardHeader>
    <CardContent>
      <BlogEditor 
        client:load 
        categories={categories}
        onSubmit={async (data) => {
          // Client-side code to handle form submission
          try {
            const response = await fetch('/api/blog/create', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(data),
            });
            
            if (!response.ok) {
              throw new Error('Failed to create blog post');
            }
            
            const result = await response.json();
            
            // Redirect to the edit page
            window.location.href = `/admin/content/blog/edit/${result.post.id}?created=true`;
          } catch (error) {
            console.error('Error creating blog post:', error);
            alert('An error occurred while creating the blog post. Please try again.');
          }
        }}
      />
    </CardContent>
  </Card>
</ContentLayout> 